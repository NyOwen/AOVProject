<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AOV 2026 </title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>GCS 2026 Êò•Â≠£Ë≥Ω</h1>
  <h2>‰æãË°åË≥Ω </h2>
  <div id="teamSelect" style="font-size: 20px;">
    
    <select id="teamA" style="color: blue;">
      <option>TEAM 1</option><option> FW</option><option>ONE</option><option>BMG</option><option>HKA</option><option>DCG</option><option>ANK</option>       
    </select>   
    <label> V.S </label>        
    <select id="teamB" style="color: red;">
      <option>TEAM 2</option><option> FW</option><option>ONE</option><option>BMG</option><option>HKA</option><option>DCG</option><option>ANK</option>       
    </select>
    <br/>
    <label>MODE:
      <select id="boMode"><option value="1">BO1</option><option value="3">BO3</option><option value="5">BO5</option><option value="7" selected>BO7</option></select>
    </label>
    <label>
      <input type="checkbox" id="globalBPCheckbox" checked>
      ÂÖ®Â±Ä BP 
    </label>
    <br/>
    <button onclick="startSeries()">MATCH START</button>
  </div>

  <!-- ÈÅ∏ÈÇä -->
  <div id="sideSelect" style="display:none;">
    <p id="sideSelectPrompt" style="font-weight:bold;"></p>
    <button class="side-button" id="btnBlue">üîµ Blue Side</button>
    <button class="side-button" id="btnRed">üî¥ Red Side</button>
  </div>
  <!-- LAST BP -->
  <div id="historySection">
  <h3>LAST BP</h3>
  <table id="historyTable" border="1" style="margin: 0 auto; border-collapse: collapse; background-color: white;">
    <thead>
      <tr>
        <th id="thHomeBan">‰∏ªÈöä BAN</th>
        <th id="thHomePick">‰∏ªÈöä PICK</th>
        <th id="thHomeSide">‰∏ªÈöä SIDE</th>
        <th>GAME</th>
        <th id="thGuestSide">ÂÆ¢Èöä SIDE</th>
        <th id="thGuestPick">ÂÆ¢Èöä PICK</th>
        <th id="thGuestBan">ÂÆ¢Èöä BAN</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>
<!-- ÊØîÂàÜÈ°ØÁ§∫ -->
  <div id="scoreBoard"></div>

  <!-- BPÈöéÊÆµË™™ÊòéÊèêÁ§∫ÊñáÂ≠ó -->
<div id="bpStageInfo"></div>

<!-- BPË°®Ê†ºÈ°ØÁ§∫ÂçÄ -->
<div id="bpTableContainer">
  <div id="bpTableWrapper" style="display: flex; justify-content: center; gap: 40px;">
    <!-- Blue Side Ë°®Ê†º -->
    <table class="bp-table" style="background-color: rgb(74, 246, 243);">
      <tr>
        <td id="blueTitle"> Blue Side</td>
        <td id="blueBan1" style="color: rgb(100, 100, 100);"></td>
        <td id="blueBan2" style="color: rgb(100, 100, 100);"></td>
        <td id="blueBan3" style="color: rgb(100, 100, 100);"></td>
        <td id="blueBan4" style="color: rgb(100, 100, 100);"></td>
      </tr>
      <tr style="color:blue">
        <td id="bluePick1"></td>
        <td id="bluePick2"></td>
        <td id="bluePick3"></td>
        <td id="bluePick4"></td>
        <td id="bluePick5"></td>
      </tr>
    </table>
    <!-- Red Side Ë°®Ê†º -->
    <table class="bp-table" style="background-color: rgb(255, 163, 97);">
      <tr>        
        <td id="redBan4" style="color: rgb(100, 100, 100);"></td>
        <td id="redBan3" style="color: rgb(100, 100, 100);"></td>
        <td id="redBan2" style="color: rgb(100, 100, 100);"></td>
        <td id="redBan1" style="color: rgb(100, 100, 100);"></td>
        <td id="redTitle"> Red Side</td>
      </tr>
      <tr style="color: red;">
        <td id="redPick5"></td>
        <td id="redPick4"></td>
        <td id="redPick3"></td>
        <td id="redPick2"></td>
        <td id="redPick1"></td>
      </tr>
    </table>
  </div>
</div>

  <div id="heroSection" style="display:none;">
    <div id="heroes"></div>
  </div>

  <!-- ÂãùË≤†ÈÅ∏Êìá -->
  <div id="winnerSelect" style=color:#fff;>
    <button id="btnWinA"></button>
    <button id="btnWinB"></button>
  </div>
  <!-- ÈáçÁΩÆÊú¨Â±ÄÊåâÈàï -->
  <div id="resetSection">
    <button id="resetRoundBtn" onclick="resetCurrentGame()" disabled>Êú¨Â±ÄÈáçÊñ∞BP</button>
  </div>

  <div id="resetAllSection" style="margin-top: 20px;">
    <button onclick="resetAll()">ÂÖ®Â†¥ÈáçÁΩÆ</button>
  </div>

  <div id="exportSection" style="display:none;">
    <button onclick="exportToCSV()">ÂåØÂá∫ÊØîË≥ΩÁµêÊûú</button>
  </div>
    
  <footer id="footer">Ver 10.14 ¬© 2025</footer>

  <script>
    const heroes =[
      "Â§úÂèâ","Â°îÊãâ","ÊÑõÈáå","Á≠±Ê∏Ö","ÈæçÈ¶¨","ËâæËúúËéâ","ÁæéÂ®ú","È∫•ÂÖãÊÄù","Á∑ãÊ∑ö","ÂºóÊ¥õÂÄ´","Âè∏ÁßëÂæ∑","ËëâÂ®ú",
      "Âè∏Á©∫Èúá","ÁãÇÈêµ","Ë≤ùÊèö","Â§èÊ¥õÁâπ","Âá±Ê†ºË∑ØÂ£´","ÁëûÂÖã","‰∫ûÈÄ£","ÂÆâÊ†ºÂàó","ËâæÁø†Áµ≤","Â§úÂß¨","Ëé´Êãâ","Áë™Ëø¶",
      "ÈòøÂ°î","Ë∂ôÈõ≤","ÁëüÊñêÊñØ","ÈùíÁ°Ø","ÊØîÊ¥õÁàæ","ÂàÄÈãíÂØ∂Ë≤ù","Ê¥õÂÖã","ÁßëÈáåÁ¥çÂç°","Á¥çÂÖãÁæÖÊñØ","Á∂∫Ëòø","ÊòüËëµ","ÊÇüÁ©∫",
      "ÊΩòÂõ†","Â•éÂÄ´","Á•ñÂç°","ÂëÇÂ∏É","Âá±ÊÅ©","ÈΩäÁàæ","Â∏ÉËêäÁâπ","ÈñÉÈõª‰ø†","ËòáÈõ¢","Ëò≠Èê∏","ÈúßÂ∑±","ÂüÉÁæÖ","Â∏ÉËêäÊÅ©",
      "Á•ûÂäõÂ•≥Ë∂Ö‰∫∫","ÊãâËå≤","ËéâËéâÂÆâ","È¢ØÊû∑","ÈòøËå≤Âç°","‰ºäËÄøÂ£´","Á©ÜÂä†Áàµ","‰ºäÊ†º","‰ª§Êúà","ÂúñÂÄ´","Â®úÂ°î‰∫û","Êµ∑Ë´æ",
      "ÂÖãÈáåÂ∏å","ÁãÑÊãâÂÖã","Ê¥õÈáåÊòÇ","ÈÇ¶Â∞º","ÁõßËúú‰∫û","ÁÄæ","Ë≤ÇËü¨","ËñáËèà","ÈòøËêäÊñØÁâπ","‰æùÂ§è","ÈáëÁ¥ç","Ê≠åËäôÊãâ",
      "ËòøÂÖí","ÊôÆÈõ∑Â°î","Âç°Ëéâ","ÈÅîÁàæË•ø","Ëã•‰ºä","ÂÆâÂ•àÁâπ","Âãá","Ê£ÆÂúñÁàæÁâπ","Âç°Ëä¨Â¶Æ","‰∫•ÁäΩ","ÁâπÁàæÂÆâÂ®úÁµ≤","Âá°ÊÅ©",
      "Â†á","Ëòá","ÈùàÈùà","Âè≤Ëò≠Ëå≤","Á∑πËéâ","ËâæÁê≥","ÊãâÁ∂≠Áàæ","Êë©ÊÅ©","Â∏åÈú≤Âç°","Á¥¢Êñá","Ëè≤Â∞ºÂÖã","Áê≥ËíÇ",
      "Êµ∑ÂÄ´","ÊÑõÈ∫óÁµ≤","ÊúµËéâ‰∫û","Âç°ÁëûËå≤","Êòé‰∏ñÈö±","ËäΩËäΩ","ÁöÆÁöÆ","Ëñ©Â∞º","Âì•Âæ∑Áàæ","ÁâõÈ≠îÁéã","ÊèêÁ±≥","ÊúóÂçö",
      "‰ºØÈ†ì","ÂÖãËêäÊñØ","Êü•ÊààÁ¥çÁàæ","Â§∏ÂÖã","Âè§Êú®","Ê≠êÁ±≥ËåÑ","ËâæÁëû","Ê∏•È¶¨Áàæ","Á∂≠ÁæÖ","ÈòøÊùúÊÅ©",
      "Ë∂Ö‰∫∫","Ë¥äÂ∞ºÁàæ","Ë´æÂèØË•ø","Ëé´ÊâòÊñØ","ÈäÄÊôù","È¶¨Ê¥õÊñØ"
    ];
    const heroRoles={
      "Â§úÂèâ":"DSL","Â°îÊãâ":"DSL","ÊÑõÈáå":"DSL","Á≠±Ê∏Ö":"DSL","ÈæçÈ¶¨":"DSL","ËâæËúúËéâ":"DSL","ÁæéÂ®ú":"DSL","È∫•ÂÖãÊÄù":"DSL","Á∑ãÊ∑ö":"DSL",
      "ÂºóÊ¥õÂÄ´":"DSL","Âè∏ÁßëÂæ∑":"DSL","ËëâÂ®ú":"DSL","Âè∏Á©∫Èúá":"DSL","ÁãÇÈêµ":"DSL","Ë≤ùÊèö":"DSL","Â§èÊ¥õÁâπ":"DSL","Âá±Ê†ºË∑ØÂ£´":"DSL",
      "ÁëûÂÖã":"DSL","‰∫ûÈÄ£":"DSL","ËâæÁø†Áµ≤":"DSL","Â§úÂß¨":"DSL","Ëé´Êãâ":"DSL","Áë™Ëø¶":"DSL","ÈòøÂ°î":"DSL","ÂëÇÂ∏É":"DSL","Â∏ÉËêäÊÅ©":"DSL",
      "Ë∂ôÈõ≤":"JUG","ÁëüÊñêÊñØ":"JUG","ÈùíÁ°Ø":"JUG","ÊØîÊ¥õÁàæ":"JUG","ÂàÄÈãíÂØ∂Ë≤ù":"JUG","Ê¥õÂÖã":"JUG","ÁßëÈáåÁ¥çÂç°":"JUG","Á¥çÂÖãÁæÖÊñØ":"JUG","Á∂∫Ëòø":"JUG","ÊòüËëµ":"JUG",
      "ÊÇüÁ©∫":"JUG","ÊΩòÂõ†":"JUG","Â•éÂÄ´":"JUG","Á•ñÂç°":"JUG","Âá±ÊÅ©":"JUG","ÈΩäÁàæ":"JUG","Â∏ÉËêäÁâπ":"JUG","ÈñÉÈõª‰ø†":"JUG","ËòáÈõ¢":"JUG",
      "Ëò≠Èê∏":"JUG","ÈúßÂ∑±":"JUG","ÂüÉÁæÖ":"JUG","Á•ûÂäõÂ•≥Ë∂Ö‰∫∫":"JUG","ÂÆâÊ†ºÂàó":"JUG",
      "ÊãâËå≤":"MID","ËéâËéâÂÆâ":"MID","È¢ØÊû∑":"MID","ÈòøËå≤Âç°":"MID","‰ºäËÄøÂ£´":"MID",
      "Á©ÜÂä†Áàµ":"MID","‰ºäÊ†º":"MID","‰ª§Êúà":"MID","ÂúñÂÄ´":"MID","Â®úÂ°î‰∫û":"MID","Êµ∑Ë´æ":"MID",
      "ÂÖãÈáåÂ∏å":"MID","ÁãÑÊãâÂÖã":"MID","Ê¥õÈáåÊòÇ":"MID","ÈÇ¶Â∞º":"MID","ÁõßËúú‰∫û":"MID","ÁÄæ":"MID",
      "Ë≤ÇËü¨":"MID","ËñáËèà":"MID","ÈòøËêäÊñØÁâπ":"MID","‰æùÂ§è":"MID","ÈáëÁ¥ç":"MID","Ê≠åËäôÊãâ":"MID",
      "ËòøÂÖí":"MID","ÊôÆÈõ∑Â°î":"MID","Âç°Ëéâ":"MID","ÈÅîÁàæË•ø":"MID","Ëã•‰ºä":"MID","ÂÆâÂ•àÁâπ":"MID",
      "Âãá":"ADL","Ê£ÆÂúñÁàæÁâπ":"ADL","Âç°Ëä¨Â¶Æ":"ADL","‰∫•ÁäΩ":"ADL","ÁâπÁàæÂÆâÂ®úÁµ≤":"ADL",
      "Âá°ÊÅ©":"ADL","Â†á":"ADL","Ëòá":"ADL","ÈùàÈùà":"ADL","Âè≤Ëò≠Ëå≤":"ADL","Á∑πËéâ":"ADL",
      "ËâæÁê≥":"ADL","ÊãâÁ∂≠Áàæ":"ADL","Êë©ÊÅ©":"ADL","Â∏åÈú≤Âç°":"ADL","Á¥¢Êñá":"ADL",
      "Ëè≤Â∞ºÂÖã":"ADL","Áê≥ËíÇ":"ADL",
      "Êµ∑ÂÄ´":"SUP","ÊÑõÈ∫óÁµ≤":"SUP","ÊúµËéâ‰∫û":"SUP",
      "Âç°ÁëûËå≤":"SUP","Êòé‰∏ñÈö±":"SUP","ËäΩËäΩ":"SUP","ÁöÆÁöÆ":"SUP",
      "Ëñ©Â∞º":"SUP","Âì•Âæ∑Áàæ":"SUP","ÁâõÈ≠îÁéã":"SUP","ÊèêÁ±≥":"SUP","ÊúóÂçö":"SUP",
      "‰ºØÈ†ì":"SUP","ÂÖãËêäÊñØ":"SUP","Êü•ÊààÁ¥çÁàæ":"SUP","Â§∏ÂÖã":"SUP","Âè§Êú®":"SUP",
      "Ê≠êÁ±≥ËåÑ":"SUP","ËâæÁëû":"SUP","Ê∏•È¶¨Áàæ":"SUP","Á∂≠ÁæÖ":"SUP","ÈòøÊùúÊÅ©":"SUP",
      "Ë∂Ö‰∫∫":"SUP","Ë¥äÂ∞ºÁàæ":"SUP","Ë´æÂèØË•ø":"SUP","Ëé´ÊâòÊñØ":"SUP","ÈäÄÊôù":"SUP","È¶¨Ê¥õÊñØ":"SUP"
    }
    const phaseSequence = [
      { team: "b", action: "Ban", count: 1 }, { team: "r", action: "Ban", count: 1 },
      { team: "b", action: "Ban", count: 1 }, { team: "r", action: "Ban", count: 1 },
      { team: "b", action: "Pick", count: 1 }, { team: "r", action: "Pick", count: 2 },
      { team: "b", action: "Pick", count: 2 }, { team: "r", action: "Pick", count: 1 },
      { team: "r", action: "Ban", count: 1 }, { team: "b", action: "Ban", count: 1 },
      { team: "r", action: "Ban", count: 1 }, { team: "b", action: "Ban", count: 1 },
      { team: "r", action: "Pick", count: 1 }, { team: "b", action: "Pick", count: 2 },
      { team: "r", action: "Pick", count: 1 }
    ];

  let teamAName = "AÈöä", teamBName = "BÈöä";
  let score = { A: 0, B: 0 };
  let currentGame = 0, maxGame = 7;
  let sideChooser = "A";
  let sideToTeam = { b: "", r: "" };
  let sideSelected = false;
  let allPicks = {};
  heroes.forEach(h => allPicks[h] = { A: false, B: false });
  let picks = { b: [], r: [] }, bans = { b: [], r: [] };
  const selectedHeroes = new Set();

  let phaseIndex = 0, phaseActionCount = 0;
  let matchHistory = [];
  let matchResults = [];

  let swapSelection = null;
  let useGlobalBP = true;

  function saveProgress() {
    const data = {
      teamAName,
      teamBName,
      score,
      currentGame,
      maxGame,
      sideChooser,
      sideToTeam,
      sideSelected,
      allPicks,
      picks,
      bans,
      phaseIndex,
      phaseActionCount,
      matchHistory,
      matchResults
    };
    localStorage.setItem("bpProgress", JSON.stringify(data));
  }

  function loadProgress() {
  const saved = localStorage.getItem("bpProgress");
  if (!saved) return;

  try {
    const data = JSON.parse(saved);

    // Ë≥áÊñôÈÇÑÂéü
    teamAName = data.teamAName;
    teamBName = data.teamBName;
    score = data.score;
    currentGame = data.currentGame;
    maxGame = data.maxGame;
    sideChooser = data.sideChooser;
    sideToTeam = data.sideToTeam;
    sideSelected = data.sideSelected;
    allPicks = data.allPicks;
    picks = data.picks;
    bans = data.bans;
    phaseIndex = data.phaseIndex;
    phaseActionCount = data.phaseActionCount;
    matchHistory = data.matchHistory || [];
    matchResults = data.matchResults || [];

    // üü° ÈáçÂª∫ selectedHeroesÔºàÁï∂Â±ÄÂ∑≤Á∂ìÈÅ∏ / Á¶ÅËã±ÈõÑÔºâ
    selectedHeroes.clear();
    Object.values(picks).forEach(arr => arr.forEach(h => selectedHeroes.add(h)));
    Object.values(bans).forEach(arr => arr.forEach(h => selectedHeroes.add(h)));

    // È°ØÁ§∫ UI ÂçÄÂ°ä
    document.getElementById("teamSelect").style.display = "none";
    if (!sideSelected) {
      document.getElementById("sideSelect").style.display = "block";
      setupSideButtons();
    } else {
      document.getElementById("resetRoundBtn").disabled = false;
    }

    // Êõ¥Êñ∞Áï´Èù¢
    updateScoreboard();
    updateHistory();
    updateBPTable();
    renderPhase();
    renderHeroes();
    setupVictoryButtons();
    updateTeamLabels();

    // Ëã•Â∑≤ÁµêÊùüÔºåÈ°ØÁ§∫ÂåØÂá∫
    if (score.A > Math.floor(maxGame / 2) || score.B > Math.floor(maxGame / 2)) {
      document.getElementById("exportSection").style.display = "block";
    }

  } catch (e) {
    console.error("ËÆÄÂèñÈÄ≤Â∫¶Â§±Êïó:", e);
    localStorage.removeItem("bpProgress");
  }
}

  function updateTeamLabels() {
    const blueEl = document.getElementById("blueTeamName");
    const redEl = document.getElementById("redTeamName");

    // Èò≤Ê≠¢Á©∫ÊåáÈáùÈåØË™§
    if (!blueEl || !redEl) return;

    const blueTeam = sideToTeam.b === "A" ? teamAName : teamBName;
    const redTeam = sideToTeam.r === "A" ? teamAName : teamBName;

    blueEl.innerText = blueTeam;
    redEl.innerText = redTeam;
  }

  function startSeries() {
    useGlobalBP = document.getElementById("globalBPCheckbox").checked;
    teamAName = document.getElementById("teamA").value;
    teamBName = document.getElementById("teamB").value;
    maxGame = parseInt(document.getElementById("boMode").value);

    if (teamAName === teamBName) {
      alert("Ë´ãÈÅ∏Êìá‰∏çÂêåÈöä‰ºçÔºÅ");
      return;
    }

    score = { A: 0, B: 0 };
    currentGame = 1;
    sideChooser = "A";
    document.getElementById("teamSelect").style.display = "none";
    document.getElementById("sideSelect").style.display = "block";
    setupSideButtons();
    updateHistory();
    updateScoreboard();
    saveProgress();
  }


    function setupSideButtons() {
    const chooserName = sideChooser === "A" ? teamAName : teamBName;
    document.getElementById("sideSelectPrompt").innerText = `GAME ${currentGame} , ${chooserName} chooses a side`;
    document.getElementById("btnBlue").onclick = () => selectSide(sideChooser, "b");
    document.getElementById("btnRed").onclick = () => selectSide(sideChooser, "r");
  }

  function selectSide(team, side) {
    sideToTeam = side === "b" ? { b: team, r: team === "A" ? "B" : "A" }
                              : { r: team, b: team === "A" ? "B" : "A" };
    sideSelected = true;
    updateScoreboard();

    document.getElementById("sideSelect").style.display = "none";
    document.getElementById("heroSection").style.display = "block";
    document.getElementById("blueTitle").innerText = ` ${sideToTeam.b === "A" ? teamAName : teamBName}`;
    document.getElementById("redTitle").innerText = ` ${sideToTeam.r === "A" ? teamAName : teamBName}`;
    setupVictoryButtons();
    renderPhase();
    renderHeroes();

    document.getElementById("resetRoundBtn").disabled = false;
    saveProgress();
  }

  function setupVictoryButtons() {
    const btnA = document.getElementById("btnWinA");
    const btnB = document.getElementById("btnWinB");
    btnA.innerText = `${teamAName} Win`;
    btnB.innerText = `${teamBName} Win`;
    btnA.onclick = () => setWinner("A");
    btnB.onclick = () => setWinner("B");
  }
  function resetCurrentGame() {
  if (!confirm("Á¢∫ÂÆöÊú¨Â±ÄÈáçÊñ∞ÈñãÂßãÂóéÔºü")) {
    return; // ‰ΩøÁî®ËÄÖÊåâ„ÄåÂèñÊ∂à„ÄçÂ∞±‰∏çÂü∑Ë°åÂæåÁ∫å
  }
  // Ê∏ÖÈô§Ë©≤Â±ÄÂÖßÈÉ®Á¥ÄÈåÑÔºà‰∏çÂΩ±ÈüøÂÖ®Â±ÄË®òÈåÑÔºâ
  selectedHeroes.clear();
  picks = { b: [], r: [] };
  bans = { b: [], r: [] };
  phaseIndex = 0;
  phaseActionCount = 0;
  updateBPTable();
  sideSelected = false;
  document.getElementById("sideSelect").style.display = "block";
  document.getElementById("bpStageInfo").innerText = "";
  setupSideButtons();

  // Èö±ËóèÂãùË≤†ÈÅ∏ÊìáÔºåÂõûÂà∞ÈÅ∏ËßíÈöéÊÆµ
  swapSelection = null;
  document.getElementById("winnerSelect").style.display = "none";
  document.getElementById("btnWinA").disabled = true;
  document.getElementById("btnWinB").disabled = true;

  renderPhase();
  renderHeroes();
  saveProgress();
}

  function setWinner(winner) {
    const bpFinished = phaseIndex >= phaseSequence.length;
    if (!sideSelected || !bpFinished) {
      console.warn("Êú™ÂÆåÊàêÈÅ∏ÈÇäÊàñBPÊµÅÁ®ãÔºå‰∏çÂèØË®≠ÂÆöÂãùË≤†");
      return;
    }
    if(useGlobalBP){
      picks.b.forEach(h => { allPicks[h][sideToTeam.b] = true; });
      picks.r.forEach(h => { allPicks[h][sideToTeam.r] = true; });
    }
    
    matchHistory.push({
      bluePick: picks.b.slice(),
      redPick: picks.r.slice(),
      blueBan: bans.b.slice(),
      redBan: bans.r.slice()
    });
    score[winner]++;
    const loser = winner === "A" ? "B" : "A";
    sideChooser = loser;
    document.getElementById("bpStageInfo").innerText ="";

    // Êñ∞Â¢ûÔºöË®òÈåÑÊú¨Â±ÄÂãùË≤†Ë≥áË®ä
    matchResults.push({
      game: currentGame,
      winner: winner,
      blue: sideToTeam.b,
      red: sideToTeam.r
    });

    currentGame++;
    document.getElementById("btnWinA").disabled = true;
    document.getElementById("btnWinB").disabled = true;

    if (score[winner] > Math.floor(maxGame / 2)) {
      alert(`Á≥ªÂàóË≥ΩÁµêÊùüÔºåÁç≤ÂãùÈöä‰ºçÔºö${winner === "A" ? teamAName : teamBName}`);
      updateScoreboard();
      document.getElementById("resetRoundBtn").disabled = true;
      document.getElementById("exportSection").style.display = "block";
      updateHistory();
      localStorage.removeItem("bpProgress");
      return;
    }
    swapSelection = null;
    resetForNextGame();
    setupSideButtons();
    document.getElementById("sideSelect").style.display = "block";
    updateScoreboard();
    updateHistory();
    saveProgress();

  }

  function updateScoreboard() {
    let blueTeam = sideToTeam.b === "A" ? teamAName : teamBName;
    let redTeam = sideToTeam.r === "B" ? teamBName : teamAName;
    let blueScore = sideToTeam.b === "A" ? score.A : score.B;
    let redScore = sideToTeam.r === "B" ? score.B : score.A;

    document.getElementById("scoreBoard").innerText =
      ` ${blueTeam} ${blueScore}-${redScore} ${redTeam} `;
  }

  function resetForNextGame() {
    selectedHeroes.clear();
    picks = { b: [], r: [] };
    bans = { b: [], r: [] };
    phaseIndex = 0;
    phaseActionCount = 0;
    sideSelected = false;
    if (!useGlobalBP) {
      heroes.forEach(h => allPicks[h] = { A: false, B: false });
    }
    updateBPTable();
    document.getElementById("resetRoundBtn").disabled = true;
  }


function renderPhase() {
const p = phaseSequence[phaseIndex];
const bpFinished = phaseIndex >= phaseSequence.length;
const sideDone = !!sideSelected;


if (!sideDone) {
document.getElementById("heroSection").style.display = "none";
document.getElementById("winnerSelect").style.display = "none";
return;
}


if (bpFinished) {
if (picks.b.length === 5 && picks.r.length === 5) {
document.getElementById("bpStageInfo").innerText =
  `FINALIZE : GAME ${currentGame}`;
document.getElementById("heroSection").style.display = "none";
document.getElementById("winnerSelect").style.display = "block";
document.getElementById("btnWinA").disabled = false;
document.getElementById("btnWinB").disabled = false;
} else {
document.getElementById("bpStageInfo").innerText = "BP ÈÄ≤Ë°å‰∏≠...";
document.getElementById("winnerSelect").style.display = "none";
document.getElementById("btnWinA").disabled = true;
document.getElementById("btnWinB").disabled = true;
}
return;
}


// ÈÄ≤Ë°å‰∏≠ÈöéÊÆµ
const currentTeam = sideToTeam[p.team];
const teamName = currentTeam === "A" ? teamAName : teamBName;
document.getElementById("bpStageInfo").innerText =
`Please ${teamName} ${p.action.toLowerCase()} ${p.count} Hero${p.count > 1 ? "es" : ""}`;
document.getElementById("heroSection").style.display = "block";
document.getElementById("winnerSelect").style.display = "none";
document.getElementById("btnWinA").disabled = true;
document.getElementById("btnWinB").disabled = true;
}

function renderHeroes() {
  const container = document.getElementById("heroes");
  container.innerHTML = "";

  // Èùû BP ÈöéÊÆµ‰∏çÈ°ØÁ§∫
  if (!sideSelected || phaseIndex >= phaseSequence.length) {
    container.style.display = "none";
    return;
  } else {
    container.style.display = "block";
  }

  const roles = ["DSL", "JUG", "MID", "ADL", "SUP"];
  const p = phaseSequence[phaseIndex];
  const currentTeam = sideToTeam[p.team]; // A or B
  const isSeventhGame = (maxGame === 7 && currentGame === 7);

  roles.forEach(role => {
    const section = document.createElement("div");
    section.className = "hero-section";

    const title = document.createElement("h3");
    title.innerText = role;
    section.appendChild(title);

    const grid = document.createElement("div");
    grid.className = "hero-grid";

    heroes.filter(h => heroRoles[h] === role).forEach(hero => {
      const btn = document.createElement("button");
      btn.innerText = hero;
      btn.className = "hero"; // ‰øùÊåÅÁèæÊúâÊ®£Âºè

      let disable = false;

      if (useGlobalBP && !isSeventhGame) {
        if (p.action === "Pick" && allPicks[hero][currentTeam]) {
          disable = true; // ÂÖ®Â±ÄÈôêÂà∂ÔºàPickÔºâ
        }
      }
      if (selectedHeroes.has(hero)) {
        disable = true; // Áï∂Â±ÄÈôêÂà∂
      }

      if (disable) {
        btn.disabled = true;
      } else {
        btn.onclick = () => handleHeroClick(hero);
      }

      grid.appendChild(btn);
    });

    section.appendChild(grid);
    container.appendChild(section);
  });
}

function handleHeroClick(hero) {
  if (!confirm(`Á¢∫ÂÆöË¶ÅÈÅ∏Êìá ${hero} ÂóéÔºü`)) {
    return; // ‰ΩøÁî®ËÄÖÊåâ„ÄåÂèñÊ∂à„ÄçÂ∞±‰∏çÂü∑Ë°åÂæåÁ∫å
  }
  const phase = phaseSequence[phaseIndex];
  if (!phase) return;

  const { team, action } = phase;
  const teamKey = sideToTeam[team];

  
  if (selectedHeroes.has(hero)) return;
  selectedHeroes.add(hero);


  if (action === "Pick") {
    picks[team].push(hero);
  } else {
    bans[team].push(hero);
  }

  updateBPTable();

  phaseActionCount++;
  if (phaseActionCount >= phase.count) {
    phaseIndex++;
    phaseActionCount = 0;
  }

  renderPhase();
  renderHeroes();
  saveProgress();
}

function updateBPTable() {
  // Êõ¥Êñ∞ËóçÊñπ Ban
  for (let i = 0; i < 4; i++) {
    const cell = document.getElementById(`blueBan${i + 1}`);
    cell.innerText = bans.b[i] || "";
  }

  // Êõ¥Êñ∞ËóçÊñπ Pick
  for (let i = 0; i < 5; i++) {
    const cell = document.getElementById(`bluePick${i + 1}`);
    const hero = picks.b[i] || "";
    cell.innerText = hero;
    cell.dataset.side = "b";
    cell.dataset.index = i;
    cell.onclick = handleSwapClick;
  }

  // Êõ¥Êñ∞Á¥ÖÊñπ Ban
  for (let i = 0; i < 4; i++) {
    const cell = document.getElementById(`redBan${i + 1}`);
    cell.innerText = bans.r[i] || "";
  }

  // Êõ¥Êñ∞Á¥ÖÊñπ Pick
  for (let i = 0; i < 5; i++) {
    const cell = document.getElementById(`redPick${i + 1}`);
    const hero = picks.r[i] || "";
    cell.innerText = hero;
    cell.dataset.side = "r";
    cell.dataset.index = i;
    cell.onclick = handleSwapClick;
  }
}

function handleSwapClick(e) {
  if (!swapSelection) {
    swapSelection = e.currentTarget;
    e.currentTarget.style.outline = "2px solid gold";
    return;
  }

  const first = swapSelection;
  const second = e.currentTarget;

  // ‰∏çÂêåÈöä‰ºç‰∏çÂèØ‰∫§Êèõ
  if (first.dataset.side !== second.dataset.side) {
    alert("Âè™ËÉΩ‰∫§ÊèõÂêå‰∏ÄÈöäÁöÑËã±ÈõÑÔºÅ");
    first.style.outline = "";
    swapSelection = null;
    return;
  }

  const side = first.dataset.side;
  const i1 = parseInt(first.dataset.index);
  const i2 = parseInt(second.dataset.index);

  // ‰∫§ÊèõÂÖßÂÆπ
  const temp = picks[side][i1];
  picks[side][i1] = picks[side][i2];
  picks[side][i2] = temp;

  // Ê∏ÖÈô§ÈÅ∏ÂèñÁãÄÊÖãËàá UI
  first.style.outline = "";
  second.style.outline = "";
  swapSelection = null;

  updateBPTable(); // ÈáçÊñ∞Ê∏≤Êüì
}

function updateHistory() {
  const history = document.getElementById("historyTable");
  history.innerHTML = "";

  const header = document.createElement("tr");
  const homeName = teamAName;
  const guestName = teamBName;

  header.innerHTML = `
    <th>${homeName} BAN</th><th>${homeName} PICK</th><th>${homeName} RESULT</th>
    <th>GAME</th>
    <th>${guestName} RESULT</th><th>${guestName} PICK</th><th>${guestName} BAN</th>
  `;
  history.appendChild(header);

  matchResults.forEach((result, i) => {
    const gameNum = i + 1;
    const match = matchHistory[i];
    const blue = result.blue;
    const red = result.red;

    const homeIsBlue = blue === "A";
    const homeBan = homeIsBlue ? match.blueBan : match.redBan;
    const homePick = homeIsBlue ? match.bluePick : match.redPick;
    const guestBan = homeIsBlue ? match.redBan : match.blueBan;
    const guestPick = homeIsBlue ? match.redPick : match.bluePick;

    const homeResult = result.winner === "A" ? "WIN" : "LOSE";
    const guestResult = result.winner === "B" ? "WIN" : "LOSE";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${homeBan.map(h => `<span style="color:${homeIsBlue ? 'blue' : 'red'}">${h}</span>`).join(", ")}</td>
      <td>${homePick.map(h => `<span style="color:${homeIsBlue ? 'blue' : 'red'}">${h}</span>`).join(", ")}</td>
      <td>${homeResult}</td>
      <td style="font-weight:bold;">${gameNum}</td>
      <td>${guestResult}</td>
      <td>${guestPick.map(h => `<span style="color:${homeIsBlue ? 'red' : 'blue'}">${h}</span>`).join(", ")}</td>
      <td>${guestBan.map(h => `<span style="color:${homeIsBlue ? 'red' : 'blue'}">${h}</span>`).join(", ")}</td>
    `;
    history.appendChild(row);
  });
}

function resetAll() {
  const confirmed = confirm("Á¢∫ÂÆöË¶ÅÈáçÁΩÆÂÖ®Â†¥ÈÄ≤Â∫¶ÂóéÔºüÈÄôÂ∞áÊ∏ÖÈô§ÊâÄÊúâË≥áÊñô‰∏¶ÈáçÊñ∞ÈñãÂßãÔºÅ");
  if (!confirmed) return;

  // Ê∏ÖÈô§ÊâÄÊúâÂÑ≤Â≠ò
  localStorage.removeItem("bpProgress");

  // ÈÇÑÂéüËÆäÊï∏
  teamAName = "AÈöä";
  teamBName = "BÈöä";
  score = { A: 0, B: 0 };
  currentGame = 0;
  maxGame = 7;
  sideChooser = "A";
  sideToTeam = { b: "", r: "" };
  sideSelected = false;
  phaseIndex = 0;
  phaseActionCount = 0;
  matchHistory = [];
  matchResults = [];

  // Ê∏ÖÈô§Ëã±ÈõÑÁãÄÊÖã
  heroes.forEach(h => allPicks[h] = { A: false, B: false });
  picks = { b: [], r: [] };
  bans = { b: [], r: [] };
  selectedHeroes.clear();

  // ÈÇÑÂéüÁï´Èù¢
  document.getElementById("teamSelect").style.display = "block";
  document.getElementById("sideSelect").style.display = "none";
  document.getElementById("heroSection").style.display = "none";
  document.getElementById("winnerSelect").style.display = "none";
  document.getElementById("exportSection").style.display = "none";
  document.getElementById("scoreBoard").innerText = "";
  document.getElementById("bpStageInfo").innerText = "";
  document.getElementById("historyTable").innerHTML = "";

  updateBPTable();
}

function exportToCSV() {
  let csv = [];
  csv.push(["Game", "Team", "Side", "Ban1", "Ban2", "Ban3", "Ban4", "Pick1", "Pick2", "Pick3", "Pick4", "Pick5", "Result"]);
  const teamARows = [];
  const teamBRows = [];

  matchResults.forEach((result, index) => {
    const gameNum = index + 1;
    const match = matchHistory[index];

    // Blue side
    const blueTeam = result.blue === "A" ? teamAName : teamBName;
    const blueResult = result.winner === result.blue ? "WIN" : "LOSE";
    const blueRow = [
      gameNum, blueTeam, "Blue",
      ...match.blueBan, ...Array(4 - match.blueBan.length).fill(""),
      ...match.bluePick, ...Array(5 - match.bluePick.length).fill(""),
      blueResult
    ];

    if (blueTeam === teamAName) {
      teamARows.push(blueRow);
    } else {
      teamBRows.push(blueRow);
    }

    // Red side
    const redTeam = result.red === "A" ? teamAName : teamBName;
    const redResult = result.winner === result.red ? "WIN" : "LOSE";
    const redRow = [
      gameNum, redTeam, "Red",
      ...match.redBan, ...Array(4 - match.redBan.length).fill(""),
      ...match.redPick, ...Array(5 - match.redPick.length).fill(""),
      redResult
    ];

    if (redTeam === teamAName) {
      teamARows.push(redRow);
    } else {
      teamBRows.push(redRow);
    }
  });

  csv.push(...teamARows);
  csv.push(...teamBRows);

  const cleanName = name => name.replace(/[^\w\u4e00-\u9fa5]/g, "");
  const fileName = `${cleanName(teamAName)}vs${cleanName(teamBName)}.csv`;
  // Âª∫Á´ã CSV Ê™îÊ°à
  const csvContent = "data:text/csv;charset=utf-8," + csv.map(e => e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", fileName);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

window.onload = function() {
  //localStorage.removeItem("bpProgress");
  loadProgress();
};
  </script>
</body>
</html>
